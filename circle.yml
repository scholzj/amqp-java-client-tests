machine:
  hosts:
    amqp-host: 127.0.0.1
  java:
    version: oraclejdk8
  services:
    - docker
  environment:
    MAVEN_TEST_SUITE: qpid-0.36.xml
    BROKER_DOCKER_IMAGE: scholzj/java-client-tests:0.36

dependencies:
  pre:
    - unzip jce_policy-8.zip
    - sudo cp UnlimitedJCEPolicyJDK8/local_policy.jar ${JAVA_HOME}/jre/lib/security
    - sudo cp UnlimitedJCEPolicyJDK8/US_export_policy.jar ${JAVA_HOME}/jre/lib/security
    - mvn install -DskipTests=true
    
test:
  pre:
    - case $CIRCLE_NODE_INDEX in 0) docker run -d -p 35672:5672 -p 35671:5671 scholzj/java-client-tests:3.0.0 ;; 1) docker run -d -p 35672:5672 -p 35671:5671 scholzj/java-client-tests:3.2.0 ;; 2) docker run -d -p 35672:5672 -p 35671:5671 scholzj/java-client-tests:0.34 ;; 3) docker run -d -p 35672:5672 -p 35671:5671 scholzj/java-client-tests:0.36 ;; esac:
        parallel: true
  override:
    - case $CIRCLE_NODE_INDEX in 0) mvn -fae test -Dsurefire.suiteXmlFiles=$(pwd)/mrg-3.0.0.xml ;; 1) mvn -fae test -Dsurefire.suiteXmlFiles=$(pwd)/mrg-3.2.0.xml ;; 2) mvn -fae test -Dsurefire.suiteXmlFiles=$(pwd)/qpid-0.34.xml ;; 3) mvn -fae test -Dsurefire.suiteXmlFiles=$(pwd)/qpid-0.36.xml ;; esac:
        parallel: true
